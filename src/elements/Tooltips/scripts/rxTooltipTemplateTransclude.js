angular.module('encore.ui.elements')
/**
 * @ngdoc directive
 * @name elements.directive:rxTooltipTemplateTranclude
 * @description
 * Element for transcluding tooltips template.
 */
.directive('rxTooltipTemplateTransclude',
    function ($animate, $sce, $compile, $templateRequest) {
        return {
            link: function (scope, elem, attrs) {
                var origScope = scope.$eval(attrs.rxTooltipTemplateTranscludeScope);

                var changeCounter = 0,
                    currentScope,
                    previousElement,
                    currentElement;

                var cleanupLastIncludeContent = function () {
                    if (previousElement) {
                        previousElement.remove();
                        previousElement = null;
                    }

                    if (currentScope) {
                        currentScope.$destroy();
                        currentScope = null;
                    }

                    if (currentElement) {
                        $animate.leave(currentElement).then(function () {
                            previousElement = null;
                        });
                        previousElement = currentElement;
                        currentElement = null;
                    }
                };

                scope.$watch($sce.parseAsResourceUrl(attrs.rxTooltipTemplateTransclude), function (src) {
                    var thisChangeId = ++changeCounter;

                    if (src) {
                        //set the 2nd param to true to ignore the template request error so that the inner
                        //contents and scope can be cleaned up.
                        $templateRequest(src, true).then(function (response) {
                            if (thisChangeId !== changeCounter) { return; }
                            var newScope = origScope.$new();
                            var template = response;

                            var clone = $compile(template)(newScope, function (clone) {
                                cleanupLastIncludeContent();
                                $animate.enter(clone, elem);
                            });

                            currentScope = newScope;
                            currentElement = clone;

                            currentScope.$emit('$includeContentLoaded', src);
                        }, function () {
                            if (thisChangeId === changeCounter) {
                                cleanupLastIncludeContent();
                                scope.$emit('$includeContentError', src);
                            }
                        });
                        scope.$emit('$includeContentRequested', src);
                    } else {
                        cleanupLastIncludeContent();
                    }
                });
                scope.$on('$destroy', cleanupLastIncludeContent);
            }
        };
    });
